# CSS、JS 放置位置与前端性能的关系？

## 浏览器的解析方式

**览器解析html页面首先浏览器先下载html，然后在内存中把html代码转化成Dom Tree，
然后浏览器根据Dom Tree上的Node分析css和Images，当文档下载遇到js时，js独立下载。**

**专业角度来谈：浏览器的渲染引擎（如 chrome 的webkit）会先构建DOM树（从<html>标签开始），在遇到外部css文件时会停止构建DOM树，转而解析css文件，构建CSSOM树，完成后会继续构建DOM树，同时与已经构建好的DOM树节点共同构建渲染树，并将内容绘制在屏幕上，而这是一个渐进的过程，不会等到DOM树与CSSOM树共同构建好完整的渲染树才会将内容呈现。**

**在遇到js文件时也会立即停止构建DOM树，启动js引擎解析js脚本，在解析js过程中，会预解析页面的剩余部分，注意：预解析只是会发送请求接受响应并加载文件而不会解析文件内容**

**当文档加载过程中遇到js文件，html文档会挂起渲染（加载解析渲染同步）的线程，不仅要等待文档中js文件
加载完毕，还要等待解析执行完毕，才可以恢复html文档的渲染线程。因为JS有可能会修改DOM；所以在编写
代码时尽可能的把js写在html的底部，等html主体和css加载完之后再进行加载js**

## 为什么要将引用的外部js放在下面，外部css放在上面

**js是阻塞加载，会影响页面加载的速度，如果js文件比较大，算法也比较复杂的话，影响更大**

**CSS放在前端是页面渲染时首先是根据DOM结构生成一个DOM树然后加上CSS样式生成一个渲染树，如果CSS放在后面可能页面会出现闪跳的感觉，或者是白屏或者布局混乱样式很丑直到CSS加载完成。**

## js非阻塞加载解决方案
1. 是用defer标签
2. 是用createElement来动态生成，但是这样有一个问题就是加载顺序在IE下不一定会是按代码写的顺序来加载，可能会影响到依赖项。
3. 是用ajax加载，也是非阻塞似的但是这种方法不支持CDN  

## JS 和 CSS 在页面中的位置，会影响其他资源（指 img 等非 js 和 css 资源）的加载顺序，究其原因，有三个值得注意的点：

1. JS 有可能会修改 DOM。典型的，可能会有 document.write. 
这意味着，在当前 JS 加载和执行完成前，后续所有资源的下载有可能是没必要的 这是 JS 阻塞后续资源下载的根本原因。

2. JS 的执行有可能依赖最新样式。这意味着，JS 代码在执行前，浏览器必须保证在此 JS 之前的所有css（无论外链还是内嵌）都已下载和解析完成。这是 CSS 阻塞后续 JS 执行的根本原因。
3. 现代浏览器很聪明，会进行prefetch优化。性能是如此重要，现代浏览器在竞争中，在 UI update 线程之外， 还会开启另一个线程，对后续 JS 和 CSS 提前下载（注意，仅提前下载，并不执行）。有了 prefetch 优化，这意味着，在不存在任何阻塞的情况下，理论上 JS 和 CSS 的下载时机都非常优先，和位置无关。 
